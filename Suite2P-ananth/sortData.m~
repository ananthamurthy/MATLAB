function sortedData = sortData(Data, plotFigures)

%nCells = size(Data,1);
%nTrials = size(Data,2);

% Trial average
Data_Avg = squeeze(mean(stimWindow_trials,2)); %2nd dimension is trials

% Sorting (based on Trial Averaged data)
% Find indices of peaks
stimWindow_trialAvg_peakIndex = zeros(1:nCells);
%sortedCellIndices = zeros(1:nCells);

for cell = 1:nCells
    [~, stimWindow_trialAvg_peakIndex(cell)] = max(Data_Avg(cell,:));
    clear value
end

sortedData = stimWindow_trials(stimWindow_trialAvg_peakIndex);

if plotFigures == 1
    fig5 = figure(5);
    subFig1 = subplot(1,2,1);
    imagesc(Data_Avg)
    title('CS + Trace + US Window - Trial Averaged')
    colorbar
    colormap(fig5,'jet')
    xlabel('Frames', ...
        'FontSize', fontSize,...
        'FontWeight', 'bold')
    set(gca,'XTick', [1,3,5])
    set(gca,'XTickLabel', {'CS'; 'Trace'; 'US'})
    ylabel('Unsorted Cells', ...
        'FontSize', fontSize, ...
        'FontWeight', 'bold')
    set(gca,'FontSize', fontSize-2)
    
    subFig2 = subplot(1,2,2);
    imagesc(sortedData)
end
